<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Sendmail_lwt (sendmail-lwt.Sendmail_lwt)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.2"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../index.html">sendmail-lwt</a> &#x00BB; Sendmail_lwt</nav><h1>Module <code>Sendmail_lwt</code></h1></header><dl><dt class="spec type" id="type-error"><a href="#type-error" class="anchor"></a><code><span class="keyword">type</span> error</code><code> = <a href="../../sendmail/Sendmail/index.html#type-error">Sendmail.error</a></code></dt></dl><dl><dt class="spec value" id="val-sendmail"><a href="#val-sendmail" class="anchor"></a><code><span class="keyword">val</span> sendmail : <span>hostname:<span><span class="type-var">'a</span> Domain_name.t</span></span> <span>&#45;&gt;</span> <span>?&#8288;port:int</span> <span>&#45;&gt;</span> <span>domain:<a href="../../colombe/Colombe/Domain/index.html#type-t">Colombe.Domain.t</a></span> <span>&#45;&gt;</span> <span>authenticator:X509.Authenticator.t</span> <span>&#45;&gt;</span> <span>?&#8288;authentication:<a href="../../sendmail/Sendmail/index.html#type-authentication">Sendmail.authentication</a></span> <span>&#45;&gt;</span> <a href="../../colombe/Colombe/Reverse_path/index.html#type-t">Colombe.Reverse_path.t</a> <span>&#45;&gt;</span> <span><a href="../../colombe/Colombe/Forward_path/index.html#type-t">Colombe.Forward_path.t</a> list</span> <span>&#45;&gt;</span> <span>(unit <span>&#45;&gt;</span> <span><span><span>(string * int * int)</span> option</span> Lwt.t</span>)</span> <span>&#45;&gt;</span> <span><span><span>(unit, <a href="index.html#type-error">error</a>)</span> Stdlib.result</span> Lwt.t</span></code></dt><dd><p><code>sendmail ~hostname ?port ~domain ~authenticator ?authentication sender
   recipients mail</code> where:</p><ul><li><code>hostname</code> is the hostname of the peer</li><li><code>port</code> the port of the SMTP peer</li><li><code>domain</code> is the domain of the sender (probably <code>localhost</code>)</li><li><code>authenticator</code> is the TLS authenticator</li><li><code>authentication</code> is the username and the password of the user</li><li><code>sender</code> is the sender</li><li><code>recipients</code> are recipients of the email</li><li><code>mail</code> stream of the mail</li></ul><p>The connection already start a TLS connection to the peer. The peer is probably available on <code>*:465</code> (the default of <code>port</code> argument). The <code>mail</code> stream <b>must</b> emit for each chunk a CRLF at the end (a line). As an user of GMail, the call of <code>sendmail</code> looks like:</p><pre><code class="ml">open Mrmime

let my_domain = Colombe.Domain.of_string_exn (Unix.gethostname ())
let my_authentication =
  { Sendmail.username= &quot;my_login&quot;
  ; Sendmail.password= &quot;my_password&quot;
  ; Sendmail.mechanism= Sendmail.PLAIN }

let sender =
  let open Mrmime.Mailbox in
  let v = Local.[ &quot;my&quot;; &quot;address&quot;; &quot;mail&quot; ] @ Domain.(domain, [ &quot;gmail&quot;; &quot;com&quot; ]) in
  Result.get_ok (Colombe_emile.to_reverse_path v)
  (* &quot;my.address.mail@gmail.com&quot; *)

let destination =
  let open Mrmime.Mailbox in
  let v = Local.[ &quot;to&quot;; &quot;joe&quot; ] @ Domain.(domain, [ &quot;gmail&quot;; &quot;com&quot; ]) in
  Result.get_ok (Colombe_emile.to_forward_path v)
  (* &quot;to.joe@gmail.com&quot; *)

let run () = sendmail
  ~hostname:Domain_name.(host_exe (of_string_exn &quot;gmail.com&quot;))
  ~domain:my_domain
  ~authentictor
  ~authentication
  sender [ destination ]
  mail

let () = match Lwt_main.run (run ()) with
  | Ok () -&gt; ()
  | Error err -&gt; Format.eprintf &quot;%a.\n%!&quot; Sendmail.pp_error err</code></pre><p><code>sendmail</code> does not strictly depend on <code>mrmime</code> or <code>emile</code>. However, we advise to use them to produce typed and well-formed mails. <code>sendmail</code> does not handle properly contents of mails as are. It just emits the stream to the pipeline directly without any changes if the line does not start with a dot (<code>&quot;.&quot;</code>). Otherwise, it prepends the line with a new dot (which has a signification in terms of SMTP).</p><p>We assume that each call of <code>mail ()</code> gives to us a line - something which ends up with CRLF (<code>&quot;\r\n&quot;</code>). By this way, we can <i>sanitize</i> the dot character - and only on this way.</p><p><code>mrmime</code> ensures to make on its way a stream which emits line per line. A non-user of <code>mrmime</code> should be aware about this assumption.</p><p><code>sendmail</code> starts by itself a TLS connection with the SMTP server.</p></dd></dl><dl><dt class="spec value" id="val-sendmail_with_starttls"><a href="#val-sendmail_with_starttls" class="anchor"></a><code><span class="keyword">val</span> sendmail_with_starttls : <span>hostname:<span><span class="type-var">'a</span> Domain_name.t</span></span> <span>&#45;&gt;</span> <span>?&#8288;port:int</span> <span>&#45;&gt;</span> <span>domain:<a href="../../colombe/Colombe/Domain/index.html#type-t">Colombe.Domain.t</a></span> <span>&#45;&gt;</span> <span>authenticator:X509.Authenticator.t</span> <span>&#45;&gt;</span> <span>?&#8288;authentication:<a href="../../sendmail/Sendmail/index.html#type-authentication">Sendmail.authentication</a></span> <span>&#45;&gt;</span> <a href="../../colombe/Colombe/Reverse_path/index.html#type-t">Colombe.Reverse_path.t</a> <span>&#45;&gt;</span> <span><a href="../../colombe/Colombe/Forward_path/index.html#type-t">Colombe.Forward_path.t</a> list</span> <span>&#45;&gt;</span> <span>(unit <span>&#45;&gt;</span> <span><span><span>(string * int * int)</span> option</span> Lwt.t</span>)</span> <span>&#45;&gt;</span> <span><span><span>(unit, <a href="../../sendmail/Sendmail_with_starttls/index.html#type-error">Sendmail_with_starttls.error</a>)</span> Stdlib.result</span> Lwt.t</span></code></dt><dd><p><code>sendmail_with_starttls</code> is <a href="index.html#val-sendmail"><code>sendmail</code></a> but a part of the communication is insecure. Usually, a SMTP service provides 2 submission services:</p><ul><li>An implicitely secured one on <code>*:465</code>.</li><li>An explicitely secured one (with <code>STARTTLS</code>) on <code>*:587</code>.</li></ul><p>The user should use the first one but in the context of the non-existence of it, the second one is available. Usage and arguments are the same. However, default value of <code>port</code> is the default value of your operating system (see <span class="xref-unresolved" title="unresolved reference to &quot;Unix.getprotobyname&quot;"><code>Unix</code>.getprotobyname</span>).</p></dd></dl></div></body></html>