<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Sendmail_lwt (sendmail-lwt.Sendmail_lwt)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.1.1"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../index.html">sendmail-lwt</a> &#x00BB; Sendmail_lwt</nav><header class="odoc-preamble"><h1>Module <code><span>Sendmail_lwt</span></code></h1></header><div class="odoc-content"><div class="odoc-spec"><div class="spec type" id="type-error" class="anchored"><a href="#type-error" class="anchor"></a><code><span><span class="keyword">type</span> error</span><span> = <a href="../../sendmail/Sendmail/index.html#type-error">Sendmail.error</a></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-sendmail" class="anchored"><a href="#val-sendmail" class="anchor"></a><code><span><span class="keyword">val</span> sendmail : 
  <span>?encoder:<span>( <span>unit <span class="arrow">&#45;&gt;</span></span> bytes )</span> <span class="arrow">&#45;&gt;</span></span>
  <span>?decoder:<span>( <span>unit <span class="arrow">&#45;&gt;</span></span> bytes )</span> <span class="arrow">&#45;&gt;</span></span>
  <span>hostname:<span><span class="type-var">'a</span> <span class="xref-unresolved">Domain_name</span>.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span>?port:int <span class="arrow">&#45;&gt;</span></span>
  <span>domain:<a href="../../colombe/Colombe/Domain/index.html#type-t">Colombe.Domain.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>authenticator:<span class="xref-unresolved">X509</span>.Authenticator.t <span class="arrow">&#45;&gt;</span></span>
  <span>?authentication:<a href="../../sendmail/Sendmail/index.html#type-authentication">Sendmail.authentication</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../colombe/Colombe/Reverse_path/index.html#type-t">Colombe.Reverse_path.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../colombe/Colombe/Forward_path/index.html#type-t">Colombe.Forward_path.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>( <span>unit <span class="arrow">&#45;&gt;</span></span> <span><span><span>(string * int * int)</span> option</span> <span class="xref-unresolved">Lwt</span>.t</span> )</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>( unit, <a href="#type-error">error</a> )</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>sendmail ~hostname ?port ~domain ~authenticator ?authentication sender
   recipients mail</code> where:</p><ul><li><code>hostname</code> is the hostname of the peer</li><li><code>port</code> the port of the SMTP peer</li><li><code>domain</code> is the domain of the sender (probably <code>localhost</code>)</li><li><code>authenticator</code> is the TLS authenticator</li><li><code>authentication</code> is the username and the password of the user</li><li><code>sender</code> is the sender</li><li><code>recipients</code> are recipients of the email</li><li><code>mail</code> stream of the mail</li></ul><p>The connection already start a TLS connection to the peer. The peer is probably available on <code>*:465</code> (the default of <code>port</code> argument). The <code>mail</code> stream <b>must</b> emit for each chunk a CRLF at the end (a line). As an user of GMail, the call of <code>sendmail</code> looks like:</p><pre><code>open Mrmime

let my_domain = Colombe.Domain.of_string_exn (Unix.gethostname ())

let my_authentication =
  {
    Sendmail.username = &quot;my_login&quot;;
    Sendmail.password = &quot;my_password&quot;;
    Sendmail.mechanism = Sendmail.PLAIN;
  }

let sender =
  let open Mrmime.Mailbox in
  let v =
    Local.[ &quot;my&quot;; &quot;address&quot;; &quot;mail&quot; ] @ Domain.(domain, [ &quot;gmail&quot;; &quot;com&quot; ])
  in
  Result.get_ok (Colombe_emile.to_reverse_path v)
(* &quot;my.address.mail@gmail.com&quot; *)

let destination =
  let open Mrmime.Mailbox in
  let v = Local.[ &quot;to&quot;; &quot;joe&quot; ] @ Domain.(domain, [ &quot;gmail&quot;; &quot;com&quot; ]) in
  Result.get_ok (Colombe_emile.to_forward_path v)
(* &quot;to.joe@gmail.com&quot; *)

let run () =
  sendmail
    ~hostname:Domain_name.(host_exe (of_string_exn &quot;gmail.com&quot;))
    ~domain:my_domain ~authentictor ~authentication sender [ destination ]
    mail

let () =
  match Lwt_main.run (run ()) with
  | Ok () -&gt; ()
  | Error err -&gt; Format.eprintf &quot;%a.\n%!&quot; Sendmail.pp_error err</code></pre><p><code>sendmail</code> does not strictly depend on <code>mrmime</code> or <code>emile</code>. However, we advise to use them to produce typed and well-formed mails. <code>sendmail</code> does not handle properly contents of mails as are. It just emits the stream to the pipeline directly without any changes if the line does not start with a dot (<code>&quot;.&quot;</code>). Otherwise, it prepends the line with a new dot (which has a signification in terms of SMTP).</p><p>We assume that each call of <code>mail ()</code> gives to us a line - something which ends up with CRLF (<code>&quot;\r\n&quot;</code>). By this way, we can <i>sanitize</i> the dot character - and only on this way.</p><p><code>mrmime</code> ensures to make on its way a stream which emits line per line. A non-user of <code>mrmime</code> should be aware about this assumption.</p><p><code>sendmail</code> starts by itself a TLS connection with the SMTP server.</p><p>The user is able to re-use pre-allocated <a href="../../colombe/Colombe/Encoder/index.html#type-encoder"><code>Colombe.Encoder.encoder</code></a> and <a href="../../colombe/Colombe/Decoder/index.html#type-decoder"><code>Colombe.Decoder.decoder</code></a> if it wants - note that these resources can <b>not</b> be shared concurrently. These resources can be huge (see <a href="../../colombe/Colombe/Encoder/index.html#val-io_buffer_size"><code>Colombe.Encoder.io_buffer_size</code></a>/<a href="../../colombe/Colombe/Decoder/index.html#val-io_buffer_size"><code>Colombe.Decoder.io_buffer_size</code></a>) and in a server context, it can be more appropriate to pre-allocate these resources and give them then to <code>sendmail</code>. By this way, the whole process will allocate only minor words.</p></div></div><div class="odoc-spec"><div class="spec value" id="val-sendmail_with_starttls" class="anchored"><a href="#val-sendmail_with_starttls" class="anchor"></a><code><span><span class="keyword">val</span> sendmail_with_starttls : 
  <span>?encoder:<span>( <span>unit <span class="arrow">&#45;&gt;</span></span> bytes )</span> <span class="arrow">&#45;&gt;</span></span>
  <span>?decoder:<span>( <span>unit <span class="arrow">&#45;&gt;</span></span> bytes )</span> <span class="arrow">&#45;&gt;</span></span>
  <span>?queue:<span>( <span>unit <span class="arrow">&#45;&gt;</span></span> <span><span>( char, <span class="xref-unresolved">Stdlib</span>.Bigarray.int8_unsigned_elt )</span> <span class="xref-unresolved">Ke</span>.Rke.t</span> )</span> <span class="arrow">&#45;&gt;</span></span>
  <span>hostname:<span><span class="type-var">'a</span> <span class="xref-unresolved">Domain_name</span>.t</span> <span class="arrow">&#45;&gt;</span></span>
  <span>?port:int <span class="arrow">&#45;&gt;</span></span>
  <span>domain:<a href="../../colombe/Colombe/Domain/index.html#type-t">Colombe.Domain.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span>authenticator:<span class="xref-unresolved">X509</span>.Authenticator.t <span class="arrow">&#45;&gt;</span></span>
  <span>?authentication:<a href="../../sendmail/Sendmail/index.html#type-authentication">Sendmail.authentication</a> <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../colombe/Colombe/Reverse_path/index.html#type-t">Colombe.Reverse_path.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><a href="../../colombe/Colombe/Forward_path/index.html#type-t">Colombe.Forward_path.t</a> list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>( <span>unit <span class="arrow">&#45;&gt;</span></span> <span><span><span>(string * int * int)</span> option</span> <span class="xref-unresolved">Lwt</span>.t</span> )</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>( unit, <a href="../../sendmail/Sendmail_with_starttls/index.html#type-error">Sendmail_with_starttls.error</a> )</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>sendmail_with_starttls</code> is <a href="#val-sendmail"><code>sendmail</code></a> but a part of the communication is insecure. Usually, a SMTP service provides 2 submission services:</p><ul><li>An implicitely secured one on <code>*:465</code>.</li><li>An explicitely secured one (with <code>STARTTLS</code>) on <code>*:587</code>.</li></ul><p>The user should use the first one but in the context of the non-existence of it, the second one is available. Usage and arguments are the same. However, default value of <code>port</code> is the default value of your operating system (see <code>Unix</code>.getprotobyname).</p></div></div></div></body></html>